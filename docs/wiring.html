<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tide Gauge — ESP32 Wiring &amp; Build Guide</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Archivo+Black&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f5f5;
    --surface: #ffffff;
    --surface2: #eeeeee;
    --border: #d4d4d4;
    --green: #16a34a;
    --amber: #b45309;
    --red: #dc2626;
    --blue: #2563eb;
    --cyan: #0369a1;
    --purple: #7c3aed;
    --text: #1a1a1a;
    --text-dim: #555555;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }
  .header {
    padding: 2rem 2rem 1rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, #e8e8e8 0%, var(--bg) 100%);
  }
  .header h1 {
    font-family: 'Archivo Black', sans-serif;
    font-size: 1.5rem;
    letter-spacing: 0.05em;
    color: var(--blue);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
  }
  .header .subtitle {
    color: var(--text-dim);
    font-size: 0.85rem;
    line-height: 1.5;
  }
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    overflow-x: auto;
  }
  .tab {
    padding: 0.75rem 1.25rem;
    cursor: pointer;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-dim);
    border: none;
    background: none;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    white-space: nowrap;
  }
  .tab:hover { color: var(--text); }
  .tab.active {
    color: var(--blue);
    border-bottom-color: var(--blue);
    background: rgba(37, 99, 235, 0.06);
  }
  .tab-content { display: none; padding: 2rem; }
  .tab-content.active { display: block; }

  .section-title {
    font-family: 'Archivo Black', sans-serif;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text);
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }
  .diagram-container {
    max-width: 700px;
    margin: 0 auto;
  }
  .wiring-svg {
    width: 100%;
    height: auto;
    filter: drop-shadow(0 4px 16px rgba(0,0,0,0.12));
    border-radius: 8px;
  }

  .notes-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    margin-top: 2rem;
    max-width: 840px;
    margin-left: auto;
    margin-right: auto;
  }
  @media (max-width: 700px) { .notes-grid { grid-template-columns: 1fr; } }
  .note-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    border-left: 3px solid var(--blue);
  }
  .note-card.amber { border-left-color: var(--amber); }
  .note-card.green { border-left-color: var(--green); }
  .note-card.red   { border-left-color: var(--red); }
  .note-card.purple{ border-left-color: var(--purple); }
  .note-card h3 {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--blue);
    margin-bottom: 0.5rem;
  }
  .note-card.amber h3  { color: var(--amber); }
  .note-card.green h3  { color: var(--green); }
  .note-card.red h3    { color: var(--red); }
  .note-card.purple h3 { color: var(--purple); }
  .note-card p {
    font-size: 0.8rem;
    line-height: 1.6;
    color: var(--text-dim);
  }
  .note-card p + p { margin-top: 0.5rem; }
  .note-card code {
    background: var(--surface2);
    padding: 0.15em 0.4em;
    border-radius: 3px;
    font-size: 0.75rem;
    color: var(--cyan);
  }

  .bom-table {
    width: 100%;
    max-width: 840px;
    margin: 0 auto;
    border-collapse: collapse;
    font-size: 0.8rem;
  }
  .bom-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    background: var(--surface2);
    color: var(--blue);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.7rem;
    border-bottom: 2px solid var(--border);
  }
  .bom-table td {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text-dim);
  }
  .bom-table tr:hover td { background: var(--surface2); color: var(--text); }
  .bom-qty {
    font-weight: 700;
    color: var(--text);
    text-align: center;
  }

  .steps { max-width: 840px; margin: 2rem auto 0; }
  .step {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.25rem;
    align-items: flex-start;
  }
  .step-num {
    flex-shrink: 0;
    width: 28px; height: 28px;
    background: var(--blue);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.75rem;
  }
  .step-text {
    font-size: 0.8rem;
    line-height: 1.6;
    color: var(--text-dim);
    padding-top: 0.2rem;
  }
  .step-text strong { color: var(--text); }
  .step-text code {
    background: var(--surface2);
    padding: 0.1em 0.35em;
    border-radius: 3px;
    font-size: 0.75rem;
    color: var(--cyan);
  }

  .code-section { max-width: 840px; margin: 0 auto; }
  .code-block {
    background: #f8f8f8;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }
  .code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }
  .code-filename { font-size: 0.8rem; color: var(--blue); font-weight: 600; }
  .copy-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 0.3rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.2s;
  }
  .copy-btn:hover { background: var(--blue); color: #fff; border-color: var(--blue); }
  .code-content {
    padding: 1.25rem;
    overflow-x: auto;
    font-size: 0.76rem;
    line-height: 1.7;
  }
  .code-content pre { margin: 0; white-space: pre; font-family: 'IBM Plex Mono', monospace; color: var(--text); }
  .hl-comment { color: #888; font-style: italic; }
  .hl-key     { color: var(--cyan); }
  .hl-num     { color: var(--purple); }
  .hl-str     { color: var(--amber); }
</style>
</head>
<body>

<div class="header">
  <h1>&#127754; Tide Gauge</h1>
  <div class="subtitle">
    Standalone ESP32 · Center-zero galvanometer · NOAA Station 9444900 Port Townsend, WA<br>
    Repurposed "Yards Per Second" gauge — ±0.5 mA end scale
  </div>
</div>

<div class="tabs">
  <button class="tab active" onclick="showTab('wiring', this)">Wiring</button>
  <button class="tab" onclick="showTab('bom', this)">Parts</button>
  <button class="tab" onclick="showTab('build', this)">Build Steps</button>
  <button class="tab" onclick="showTab('firmware', this)">Firmware</button>
</div>

<!-- ══════════════════════════════════════════════════════ WIRING TAB -->
<div id="wiring" class="tab-content active">
  <div class="diagram-container">
    <h2 class="section-title">Schematic</h2>

    <svg class="wiring-svg" viewBox="0 0 700 520" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrow" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#555"/>
        </marker>
        <marker id="arrow-blue" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#2563eb"/>
        </marker>
        <marker id="arrow-red" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#dc2626"/>
        </marker>
        <marker id="arrow-green" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#16a34a"/>
        </marker>
        <marker id="arrow-orange" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="#b45309"/>
        </marker>
      </defs>

      <!-- Background -->
      <rect width="700" height="520" fill="#fafafa" rx="8"/>

      <!-- ── ESP32 board ──────────────────────────────────────────── -->
      <rect x="40" y="120" width="160" height="280" rx="6"
            fill="#f0f4ff" stroke="#2563eb" stroke-width="2"/>
      <text x="120" y="113" text-anchor="middle"
            font-family="IBM Plex Mono, monospace" font-size="11" font-weight="700"
            fill="#2563eb" letter-spacing="1">ESP32-WROOM-32</text>

      <!-- Left-side pins (GND, 3.3V) -->
      <rect x="40" y="160" width="30" height="16" rx="3" fill="#1a1a1a"/>
      <text x="55" y="172" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#fff">GND</text>

      <rect x="40" y="184" width="30" height="16" rx="3" fill="#dc2626"/>
      <text x="55" y="196" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#fff">3V3</text>

      <!-- Right-side pins -->
      <!-- GPIO26 -->
      <rect x="170" y="220" width="30" height="16" rx="3" fill="#16a34a"/>
      <text x="185" y="232" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#fff">IO26</text>
      <text x="163" y="232" text-anchor="end" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#555">DAC2</text>

      <!-- ── Voltage Divider ─────────────────────────────────────── -->
      <!-- 3.3V rail top -->
      <rect x="310" y="120" width="80" height="22" rx="4" fill="#dc2626" opacity="0.9"/>
      <text x="350" y="135" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" font-weight="700" fill="#fff">3.3 V</text>

      <!-- R1 top (10kΩ) -->
      <rect x="328" y="158" width="44" height="18" rx="3" fill="#fff" stroke="#999" stroke-width="1.5"/>
      <text x="350" y="171" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" fill="#333">10 kΩ</text>

      <!-- midpoint dot -->
      <circle cx="350" cy="200" r="5" fill="#b45309"/>
      <text x="362" y="204" font-family="IBM Plex Mono, monospace"
            font-size="10" fill="#b45309" font-weight="700">1.65 V</text>

      <!-- R2 bottom (10kΩ) -->
      <rect x="328" y="213" width="44" height="18" rx="3" fill="#fff" stroke="#999" stroke-width="1.5"/>
      <text x="350" y="226" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" fill="#333">10 kΩ</text>

      <!-- GND bottom rail -->
      <rect x="318" y="246" width="64" height="18" rx="4" fill="#1a1a1a" opacity="0.85"/>
      <text x="350" y="259" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" font-weight="700" fill="#fff">GND</text>

      <!-- Vertical wires in divider -->
      <line x1="350" y1="142" x2="350" y2="158" stroke="#dc2626" stroke-width="2"/>
      <line x1="350" y1="176" x2="350" y2="200" stroke="#999" stroke-width="2"/>
      <line x1="350" y1="200" x2="350" y2="213" stroke="#999" stroke-width="2"/>
      <line x1="350" y1="231" x2="350" y2="246" stroke="#555" stroke-width="2"/>

      <!-- 3.3V source from ESP32 -->
      <line x1="70" y1="192" x2="70" y2="100" stroke="#dc2626" stroke-width="2"/>
      <line x1="70" y1="100" x2="350" y2="100" stroke="#dc2626" stroke-width="2"/>
      <line x1="350" y1="100" x2="350" y2="120" stroke="#dc2626" stroke-width="2"/>

      <!-- GND from ESP32 -->
      <line x1="55" y1="160" x2="55" y2="82" stroke="#333" stroke-width="2"/>
      <line x1="55" y1="82" x2="490" y2="82" stroke="#333" stroke-width="2" stroke-dasharray="4,2"/>

      <!-- ── Series resistor R3 (3kΩ) on GPIO26 side ───────────── -->
      <rect x="226" y="220" width="52" height="18" rx="3" fill="#fff" stroke="#999" stroke-width="1.5"/>
      <text x="252" y="233" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" fill="#333">3 kΩ</text>
      <text x="252" y="216" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#16a34a">R3</text>

      <!-- GPIO26 → R3 -->
      <line x1="200" y1="228" x2="226" y2="228" stroke="#16a34a" stroke-width="2"
            marker-end="url(#arrow-green)"/>
      <!-- R3 → gauge+ -->
      <line x1="278" y1="228" x2="450" y2="228" stroke="#16a34a" stroke-width="2"
            marker-end="url(#arrow-green)"/>

      <!-- ── Series resistor R4 (3kΩ) on ref side ─────────────── -->
      <rect x="406" y="190" width="52" height="18" rx="3" fill="#fff" stroke="#999" stroke-width="1.5"/>
      <text x="432" y="203" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" fill="#333">3 kΩ</text>
      <text x="432" y="186" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#b45309">R4</text>

      <!-- 1.65V midpoint → R4 -->
      <line x1="393" y1="200" x2="406" y2="199" stroke="#b45309" stroke-width="2"/>
      <!-- R4 → gauge- -->
      <line x1="458" y1="199" x2="490" y2="262" stroke="#b45309" stroke-width="2"
            marker-end="url(#arrow-orange)"/>

      <!-- ── Galvanometer ─────────────────────────────────────── -->
      <!-- Body -->
      <rect x="450" y="200" width="120" height="120" rx="8"
            fill="#fffdf0" stroke="#b45309" stroke-width="2"/>

      <!-- Dial face -->
      <circle cx="510" cy="265" r="46" fill="#fff9e6" stroke="#b45309" stroke-width="1.5"/>

      <!-- Scale arc marks (simplified) -->
      <g stroke="#555" stroke-width="1">
        <!-- Center mark -->
        <line x1="510" y1="222" x2="510" y2="232"/>
        <!-- Left marks -->
        <line x1="479" y1="230" x2="484" y2="238"/>
        <line x1="462" y1="250" x2="470" y2="254"/>
        <!-- Right marks -->
        <line x1="541" y1="230" x2="536" y2="238"/>
        <line x1="558" y1="250" x2="550" y2="254"/>
      </g>

      <!-- "YARDS PER SECOND" label on gauge -->
      <text x="510" y="258" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="7" fill="#888" letter-spacing="0.5">YARDS PER SECOND</text>

      <!-- Center needle (pointing up = tide at MSL) -->
      <line x1="510" y1="265" x2="510" y2="230"
            stroke="#dc2626" stroke-width="2" stroke-linecap="round"/>
      <circle cx="510" cy="265" r="4" fill="#555"/>

      <!-- +/- labels -->
      <text x="463" y="274" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#888">−</text>
      <text x="557" y="274" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="9" fill="#888">+</text>
      <text x="510" y="302" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="8" fill="#b45309">± 0.5 mA</text>

      <!-- Gauge terminal labels -->
      <text x="452" y="296" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="8" fill="#16a34a" font-weight="700">+</text>
      <text x="568" y="296" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="8" fill="#b45309" font-weight="700">−</text>

      <!-- GND rail to gauge-negative terminal via divider bottom -->
      <line x1="490" y1="82" x2="490" y2="316" stroke="#333" stroke-width="1.5" stroke-dasharray="4,2"/>

      <!-- ── Legend ─────────────────────────────────────────────── -->
      <rect x="40" y="430" width="620" height="72" rx="6"
            fill="#fff" stroke="#d4d4d4" stroke-width="1"/>
      <text x="60" y="448" font-family="IBM Plex Mono, monospace" font-size="10"
            font-weight="700" fill="#555" letter-spacing="1">LEGEND</text>

      <line x1="60" y1="462" x2="100" y2="462" stroke="#16a34a" stroke-width="2"/>
      <text x="108" y="466" font-family="IBM Plex Mono, monospace" font-size="10" fill="#555">GPIO26 → gauge+ (signal)</text>

      <line x1="60" y1="480" x2="100" y2="480" stroke="#b45309" stroke-width="2"/>
      <text x="108" y="484" font-family="IBM Plex Mono, monospace" font-size="10" fill="#555">1.65 V ref → gauge− (center bias)</text>

      <line x1="310" y1="462" x2="350" y2="462" stroke="#dc2626" stroke-width="2"/>
      <text x="358" y="466" font-family="IBM Plex Mono, monospace" font-size="10" fill="#555">3.3 V power</text>

      <line x1="310" y1="480" x2="350" y2="480" stroke="#333" stroke-width="2" stroke-dasharray="4,2"/>
      <text x="358" y="484" font-family="IBM Plex Mono, monospace" font-size="10" fill="#555">GND</text>

      <!-- ── Title / caption ────────────────────────────────────── -->
      <text x="350" y="30" text-anchor="middle" font-family="Archivo Black, sans-serif"
            font-size="14" fill="#2563eb" letter-spacing="1">TIDE GAUGE — CENTER-ZERO DRIVE</text>
      <text x="350" y="50" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" fill="#888">GPIO26 (DAC2) differential drive · MSL = DAC 128 (1.65 V)</text>
      <text x="350" y="66" text-anchor="middle" font-family="IBM Plex Mono, monospace"
            font-size="10" fill="#888">+8 ft from MSL = DAC 255  ·  −8 ft from MSL = DAC 0</text>
    </svg>
  </div>

  <div class="notes-grid">
    <div class="note-card green">
      <h3>GPIO26 Side (gauge +)</h3>
      <p>GPIO26 (DAC2) drives the positive terminal through a <code>3 kΩ</code> resistor.</p>
      <p>DAC range 0–3.3 V. At DAC 128 the output is 1.65 V — same as the reference side — so no current flows and the needle sits at center.</p>
    </div>
    <div class="note-card amber">
      <h3>Voltage Divider (gauge −)</h3>
      <p>Two <code>10 kΩ</code> resistors from 3.3 V to GND produce a stable 1.65 V reference.</p>
      <p>This feeds the negative terminal through a matching <code>3 kΩ</code> series resistor, so both sides see the same source impedance.</p>
    </div>
    <div class="note-card blue">
      <h3>Current Calculation</h3>
      <p>Max differential voltage = 1.65 V (when DAC at 0 or 255).</p>
      <p>Total series resistance ≈ 6 kΩ (3 kΩ each side).<br>
         Peak current ≈ <code>1.65 V ÷ 6 kΩ ≈ 0.28 mA</code>.<br>
         Gauge rated ±0.5 mA, so this is well within safe range.</p>
    </div>
    <div class="note-card red">
      <h3>Calibration</h3>
      <p>If the needle rests off-center with no tide data, trim the 1.65 V reference with a <code>10 kΩ trimpot</code> in place of one of the fixed resistors.</p>
      <p>In firmware: adjust <code>DAC_CENTER</code> (default 128) to shift zero point.</p>
    </div>
    <div class="note-card purple">
      <h3>Tide Scale</h3>
      <p>NOAA station 9444900 Port Townsend: MSL = 8.35 ft above MLLW.</p>
      <p>Gauge maps <code>±8 ft</code> from MSL to full deflection. Adjust <code>TIDE_SCALE_FT</code> in firmware if the local tidal range is smaller.</p>
    </div>
    <div class="note-card">
      <h3>DAC Note</h3>
      <p>ESP32 DAC outputs are GPIO25 (DAC1) and GPIO26 (DAC2). Both are 8-bit.</p>
      <p>Do <strong>not</strong> use GPIO26 for anything else while the gauge is connected. The DAC shares silicon with the ADC2 channel; ADC reads on this pin will be inaccurate.</p>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════ BOM TAB -->
<div id="bom" class="tab-content">
  <h2 class="section-title">Bill of Materials</h2>
  <table class="bom-table">
    <thead>
      <tr>
        <th>Qty</th>
        <th>Part</th>
        <th>Value / Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr><td class="bom-qty">1</td><td>ESP32-WROOM-32 dev board</td><td>Any 38-pin ESP32 devkit works</td></tr>
      <tr><td class="bom-qty">1</td><td>Center-zero galvanometer</td><td>±0.5 mA end scale ("Yards Per Second")</td></tr>
      <tr><td class="bom-qty">2</td><td>Resistor 3 kΩ</td><td>R3 &amp; R4 — series limiters (use 2.7 kΩ–3.3 kΩ)</td></tr>
      <tr><td class="bom-qty">2</td><td>Resistor 10 kΩ</td><td>R1 &amp; R2 — voltage divider (or use one 10 kΩ trimpot + one 10 kΩ fixed)</td></tr>
      <tr><td class="bom-qty">1</td><td>Mini breadboard or perfboard</td><td>For the voltage divider</td></tr>
      <tr><td class="bom-qty">1</td><td>USB-C cable + 5 V supply</td><td>Powers ESP32</td></tr>
      <tr><td class="bom-qty">—</td><td>Hook-up wire</td><td>26–28 AWG stranded</td></tr>
    </tbody>
  </table>
</div>

<!-- ══════════════════════════════════════════════════ BUILD STEPS TAB -->
<div id="build" class="tab-content">
  <h2 class="section-title">Build Steps</h2>
  <div class="steps">
    <div class="step">
      <div class="step-num">1</div>
      <div class="step-text">
        <strong>Voltage divider.</strong> Connect two <code>10 kΩ</code> resistors in series between 3.3 V and GND.
        The midpoint gives a stable 1.65 V reference. Verify with a multimeter before connecting the gauge.
      </div>
    </div>
    <div class="step">
      <div class="step-num">2</div>
      <div class="step-text">
        <strong>Series resistors.</strong> Add a <code>3 kΩ</code> resistor in-line on the GPIO26 wire (R3) and
        a second <code>3 kΩ</code> resistor between the 1.65 V midpoint and the gauge negative terminal (R4).
        These protect the DAC output and the meter coil.
      </div>
    </div>
    <div class="step">
      <div class="step-num">3</div>
      <div class="step-text">
        <strong>Connect gauge.</strong> GPIO26 → R3 → gauge <strong>+</strong> terminal.
        1.65 V midpoint → R4 → gauge <strong>−</strong> terminal.
        Identify polarity by powering the ESP32, running <code>dacWrite(26, 200)</code>, and confirming
        the needle deflects positive. Swap leads if it deflects negative.
      </div>
    </div>
    <div class="step">
      <div class="step-num">4</div>
      <div class="step-text">
        <strong>Flash firmware.</strong> Open project in PlatformIO and run <code>pio run -t upload</code>.
        On first boot the ESP32 opens a WiFi AP named <strong>TideGauge</strong>. Connect and enter your
        WiFi credentials in the captive portal.
      </div>
    </div>
    <div class="step">
      <div class="step-num">5</div>
      <div class="step-text">
        <strong>Boot sweep.</strong> Watch the needle sweep center → full positive → full negative → center.
        This confirms the gauge drive is working before any tide data is fetched.
      </div>
    </div>
    <div class="step">
      <div class="step-num">6</div>
      <div class="step-text">
        <strong>Verify tide reading.</strong> Open <code>http://&lt;device-ip&gt;/</code> in a browser.
        Compare the displayed tide level to the NOAA website for station 9444900.
        The needle should center when tide equals MSL (8.35 ft above MLLW at Port Townsend).
      </div>
    </div>
    <div class="step">
      <div class="step-num">7</div>
      <div class="step-text">
        <strong>Zero adjustment.</strong> If the needle rests slightly off center when tide = MSL,
        adjust <code>DAC_CENTER</code> in <code>src/main.cpp</code> (default 128) up or down by a few counts,
        then reflash.
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════ FIRMWARE TAB -->
<div id="firmware" class="tab-content">
  <h2 class="section-title">Firmware Overview</h2>
  <div class="code-section">

    <div class="notes-grid" style="margin-top:0;margin-bottom:1.5rem">
      <div class="note-card green">
        <h3>NOAA Tide API</h3>
        <p>Station <code>9444900</code> Port Townsend, WA. Polls water level every <code>6 min</code> and hi/lo predictions every cycle. Uses MLLW datum, English units.</p>
      </div>
      <div class="note-card blue">
        <h3>Weather</h3>
        <p>Open-Meteo API — no key required. Fetches current temperature, wind, and WMO weather code every <code>15 min</code>. Coordinates: <code>48.115, −122.760</code> (Freeland WA).</p>
      </div>
      <div class="note-card">
        <h3>Web Page</h3>
        <p>Embedded dark-theme HTML served from <code>http://&lt;ip&gt;/</code>. Auto-refreshes every 30 s. Includes a tide bar, next hi/lo, weather panel, WiFi info, and a Reset WiFi button.</p>
      </div>
      <div class="note-card amber">
        <h3>WiFiManager</h3>
        <p>AP name: <strong>TideGauge</strong>. Portal times out after 3 minutes and reboots. Saved credentials survive power cycles. Reset button at <code>/reset</code> clears them.</p>
      </div>
    </div>

    <div class="code-block">
      <div class="code-header">
        <span class="code-filename">platformio.ini</span>
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
      </div>
      <div class="code-content"><pre><span class="hl-comment">[env:esp32dev]</span>
platform  = espressif32
board     = esp32dev
framework = arduino

lib_deps =
  tzapu/WiFiManager @ ^2.0.17
  bblanchon/ArduinoJson @ ^7.0.0

monitor_speed = 115200
upload_speed  = 921600</pre></div>
    </div>

    <div class="code-block">
      <div class="code-header">
        <span class="code-filename">Key constants — src/main.cpp</span>
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
      </div>
      <div class="code-content"><pre><span class="hl-comment">// ── Pin / scale ──────────────────────────────</span>
<span class="hl-key">#define</span> DAC_PIN       <span class="hl-num">26</span>
<span class="hl-key">#define</span> DAC_CENTER    <span class="hl-num">128</span>   <span class="hl-comment">// 1.65 V mid-point → needle at center</span>
<span class="hl-key">#define</span> TIDE_SCALE_FT <span class="hl-num">8.0f</span>  <span class="hl-comment">// ±8 ft from MSL = full deflection</span>
<span class="hl-key">#define</span> NOAA_MSL_FT   <span class="hl-num">8.35f</span> <span class="hl-comment">// Port Townsend MSL above MLLW</span>

<span class="hl-comment">// ── Poll intervals ───────────────────────────</span>
<span class="hl-key">#define</span> TIDE_INTERVAL_MS    <span class="hl-num">360000UL</span>  <span class="hl-comment">//  6 min</span>
<span class="hl-key">#define</span> WEATHER_INTERVAL_MS <span class="hl-num">900000UL</span>  <span class="hl-comment">// 15 min</span>
<span class="hl-key">#define</span> DISPLAY_INTERVAL_MS   <span class="hl-num">5000UL</span>  <span class="hl-comment">//  5 s needle update</span>

<span class="hl-comment">// ── Tide → DAC mapping ───────────────────────</span>
uint8_t tideToDAC(float deltaMSL) {
  float clamped    = constrain(deltaMSL, -TIDE_SCALE_FT, TIDE_SCALE_FT);
  float normalized = clamped / TIDE_SCALE_FT; <span class="hl-comment">// −1.0 to +1.0</span>
  int   dac        = DAC_CENTER + (int)(normalized * 127.0f);
  return (uint8_t)constrain(dac, 0, 255);
}</pre></div>
    </div>

  </div>
</div>

<script>
  function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
  }

  function copyCode(btn) {
    const pre = btn.closest('.code-block').querySelector('pre');
    navigator.clipboard.writeText(pre.innerText).then(() => {
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1500);
    });
  }
</script>
</body>
</html>
